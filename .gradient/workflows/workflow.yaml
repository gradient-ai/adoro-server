on:
  github:
    branches:
      only: main

jobs:
  CloneRepo:
    resources:
      instance-type: C3
    outputs:
      repo:
        type: volume
    uses: git-checkout@v1
    with:
      url: https://github.com/AliaksandrSiarohin/first-order-model.git
      path: /outputs/repo
  DownloadWeights:
    resources:
      instance-type: C3
    outputs:
      model:
        type: dataset
        with:
          ref: vox-adv-cpk
    uses: script@v1
    with:
      script: |-
        pip install gdown 
        gdown https://drive.google.com/uc?id=1L8P-hpBhZi8Q_1vP2KlQ4N6dvlzpYBvZ -O /outputs/model/vox.pt
      image: python:3.8
  RunModel:
    resources:
      instance-type: P5000
    needs:
      - DownloadWeights
      - CloneRepo
    inputs:
      repo: CloneRepo.outputs.repo
      model: DownloadWeights.outputs.model
      faces:
        type: dataset
        with:
          ref: input-photos
    uses: script@v1
    with:
      script: |-
        cp -r /inputs/repo/ repo/
        cp /inputs/model/vox.pt repo/vox.pt
        cd repo/
        DEBIAN_FRONTEND=noninteractive apt-get -qq update \
          && DEBIAN_FRONTEND=noninteractive apt-get -qqy install python3-pip
        pip install \
          https://download.pytorch.org/whl/cu100/torch-1.0.0-cp36-cp36m-linux_x86_64.whl \
          -r requirements.txt
      image: nvcr.io/nvidia/cuda:10.0-cudnn7-runtime-ubuntu18.04
